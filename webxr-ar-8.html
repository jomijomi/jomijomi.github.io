<!DOCTYPE html>
<html lang="en">
<style>
    textarea {
        vertical-align: bottom;
    }

    #output {
        overflow: auto;
    }

        #output > p {
            overflow-wrap: break-word;
        }

        #output span {
            color: blue;
        }

            #output span.error {
                color: red;
            }
</style>
<body>
    <h2>WebSocket Test v6.9</h2>
    <textarea cols="60" rows="3"></textarea>
    <button>Send</button>
    <button id="close_socket_button">Close Socket</button>
    <button id="save_test_button">Save test</button>
    <div id="output"></div>
</body>
<script>
    
    const button = document.querySelector("button");
    const output = document.querySelector("#output");
    const textarea = document.querySelector("textarea");
    const theCloseSocketButton = document.getElementById("close_socket_button");
    theCloseSocketButton.addEventListener("click", onClickCloseSocketButton);

    const theSaveTestButton = document.getElementById("save_test_button");
    theSaveTestButton.addEventListener("click", onClickSaveTestButton);

    let saveCounter = 0;

    //const wsUri = "ws://127.0.0.1/";    
    //const theWebsocket = new WebSocket(wsUri);
    //const theWebsocket = null;
    let theWebsocket = null;

    button.addEventListener("click", onClickButton);

    /*
    websocket.onopen = (e) => {
        writeToScreen("CONNECTED");
        doSend("WebSocket rocks");
    };

    websocket.onclose = (e) => {
        writeToScreen("DISCONNECTED");
    };

    websocket.onmessage = (e) => {
        writeToScreen(`<span>RESPONSE: ${e.data}</span>`);
    };

    websocket.onerror = (e) => {
        writeToScreen(`<span class="error">ERROR:</span> ${e.data}`);
    };
    */

    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }


    function onClickSaveTestButton() {
        console.log('before save');
        saveCounter += 1;
        var filename = 'test';
        filename += saveCounter.toString();
        filename += '.txt';
        //download('test.txt', 'Hello world!');
        download(filename, 'Hello world!');
        console.log('after save');        
    }
    

    function doSend(message) {
        writeToScreen(`SENT: ${message}`);
        theWebsocket.send(message);
    }

    function writeToScreen(message) {
        output.insertAdjacentHTML("afterbegin", `<p>${message}</p>`);
    }

    function onClickCloseSocketButton() {
        if (theWebsocket == null) {
            console.log('cannot close non-open socket!');
        }
        else {
            theWebsocket.close();
            theWebsocket = null;
        }
    }

    function onClickButton() {

        console.log('onClickButton');
        const text = textarea.value;
        console.log(text);
        theWebsocket = new WebSocket(text);

        theWebsocket.onopen = (e) => {

            console.log('CONNECTED');
            writeToScreen("CONNECTED");
            //doSend("WebSocket rocks");
        };

        theWebsocket.onclose = (e) => {
            console.log('DISCONNECTED');
            writeToScreen("DISCONNECTED");
        };

        theWebsocket.onmessage = (e) => {
            console.log('onmessage');
            //writeToScreen(`<span>RESPONSE: ${e.data}</span>`);

            console.log('before save');
            saveCounter += 1;
            var filename = 'test';
            filename += saveCounter.toString();
            filename += '.txt';
            //download('test.txt', 'Hello world!');
            download(filename, e.data);
            console.log('after save');        
        };

        theWebsocket.onerror = (e) => {
            console.log('onerror');
            console.log(e.data);
            writeToScreen(`<span class="error">ERROR:</span> ${e.data}`);
        };


        /*
        text && doSend(text);
        textarea.value = "";
        textarea.focus();
        */
    }
</script>
</html>